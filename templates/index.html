<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mapa de Gimnasios en Ensenada</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f9f9f9;
      }
      h2 {
        text-align: center;
        padding: 20px 0;
        color: #444;
      }
      #map {
        height: 90vh;
        width: 100%;
      }
      .popup-content {
        font-size: 14px;
      }
      .popup-content b {
        color: #c0392b;
      }
    </style>
  </head>
  <body>
    <h2>Mapa de Gimnasios en Ensenada</h2>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <!-- Leaflet Heatmap JS -->
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
      // 1. Crear mapa centrado en Ensenada
      var map = L.map("map").setView([31.8659, -116.5965], 12);

      // 2. Mapa base elegante
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 19,
        }
      ).addTo(map);

      // 3. Marker rojo simple
      var redMarker = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
        shadowSize: [41, 41],
      });

      // 4. Crear grupo de clusters
      var markers = L.markerClusterGroup();

      // 5. Preparar array de heatmap
      var heatPoints = [];

      // 6. ParÃ¡metros de BBOX
      var lat_min = 31.5;
      var lat_max = 32.2;
      var lon_min = -117.0;
      var lon_max = -116.3;

      // 7. Cargar datos desde la API
      fetch(
        `/api/datos_negocios?lat_min=${lat_min}&lat_max=${lat_max}&lon_min=${lon_min}&lon_max=${lon_max}`
      )
        .then((response) => response.json())
        .then((data) => {
          data.forEach(function (negocio) {
            if (negocio.latitud && negocio.longitud) {
              // Marker
              var marker = L.marker([negocio.latitud, negocio.longitud], {
                icon: redMarker,
              }).bindPopup(
                `<div class="popup-content">
              <b>${negocio.nom_estab}</b><br>
              Tel: ${negocio.telefono || "-"}<br>
              Email: ${negocio.correoelec || "-"}<br>
              Web: ${negocio.web || "-"}
            </div>`
              );
              markers.addLayer(marker);

              // Agregar al heatmap
              heatPoints.push([negocio.latitud, negocio.longitud, 1]);
            }
          });

          // Agregar clusters al mapa
          map.addLayer(markers);

          // Crear heatmap
          var heat = L.heatLayer(heatPoints, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            gradient: { 0.2: "blue", 0.4: "lime", 0.6: "orange", 0.8: "red" },
          }).addTo(map);
        })
        .catch((error) => console.error("Error cargando datos:", error));
    </script>
  </body>
</html>
